@model GESTION.Models.CompraViewModel

@{
    ViewBag.Title = "Nueva Compra";
}
<h2>Nueva Compra</h2>


@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}


@if (ViewBag.Error != null)
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}

@using (Html.BeginForm("Crear", "Compra", FormMethod.Post))
{
    @Html.AntiForgeryToken()
    <div class="form-row">
        <div class="form-group col-md-3">
            @Html.LabelFor(m => m.Encabezado.Serie)
            @Html.TextBoxFor(m => m.Encabezado.Serie, new { @class = "form-control" })
        </div>
        <div class="form-group col-md-3">
            @Html.LabelFor(m => m.Encabezado.Numero)
            @Html.TextBoxFor(m => m.Encabezado.Numero, new { @class = "form-control" })
        </div>
        <div class="form-group col-md-3">
            @Html.LabelFor(m => m.Encabezado.Fecha)
            @Html.TextBoxFor(m => m.Encabezado.Fecha, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
        </div>
        <div class="form-group col-md-3">
            @Html.LabelFor(m => m.Encabezado.ProveedorId, "Proveedor")
            @Html.DropDownListFor(m => m.Encabezado.ProveedorId, Model.Proveedores, "-- Selecciona --", new { @class = "form-control" })
        </div>
    </div>

    <div class="card mt-4 p-3">
        <h5>Agregar productos al detalle</h5>
        <div class="form-inline mb-2">
            <input id="txtBuscar" type="text" class="form-control mr-2" placeholder="Teclea ≥4 letras..." style="width:300px" />
            <button id="btnBuscar" type="button" class="btn btn-info">Buscar</button>
        </div>
        <ul id="listaResultados" class="list-group mb-3" style="max-width:400px;"></ul>

        <table class="table table-bordered" id="detalleTabla">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Comentario</th>
                    <th>Precio</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button type="submit" class="btn btn-primary">Guardar Compra</button>
}

@section scripts {
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
    let index = 0;

    // Al hacer click en Buscar
    $('#btnBuscar').click(function(){
        const term = $('#txtBuscar').val().trim();
        if (term.length < 4) { alert('Teclea al menos 4 caracteres.'); return; }
        $.getJSON('@Url.Action("BuscarProductos")', { term }, function(data){
            const $ul = $('#listaResultados').empty();
            if (!data.length) {
                $ul.append('<li class="list-group-item">No hay coincidencias.</li>');
            } else {
                data.forEach(p => {
                    $ul.append(
                        `<li class="list-group-item list-group-item-action"
                             data-id="${p.Id}"
                             data-nombre="${p.Nombre}"
                             data-marca="${p.Marca}"
                             data-precio="${p.Precio}">
                            ${p.Nombre} (${p.Marca})
                         </li>`
                    );
                });
            }
        });
    });

    // Al seleccionar un producto de la lista
    $('#listaResultados').on('click','li', function(){
        const p = {
            id:    $(this).data('id'),
            nombre:`${$(this).data('nombre')} (${$(this).data('marca')})`,
            precio: $(this).data('precio')
        };
        agregarFila(p);
        $('#listaResultados').empty();
        $('#txtBuscar').val('');
    });

        function agregarFila(p) {
            const $tbody = $('#detalleTabla tbody');
            const row = `<tr>
        <td>
            ${p.nombre}
            <input type="hidden" name="Detalles[${index}].Producto_Id" value="${p.id}" />
        </td>
        <td>
            <input name="Detalles[${index}].Cantidad"
                   type="number" class="form-control" min="1" value="1" />
        </td>
        <td>
            <input name="Detalles[${index}].Comentario"
                   type="text" class="form-control" />
        </td>
        <td>
            <input name="Detalles[${index}].Precio"
                   type="number" class="form-control" step="0.01" min="0" value="${p.precio}" />
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm"
                    onclick="$(this).closest('tr').remove()">X</button>
        </td>
    </tr>`;
            $tbody.append(row);
            index++;
        }

    </script>
}
